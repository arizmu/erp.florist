<x-base-layout>
    <div class="breadcrumbs">
        <ol>
            <li>
                <a href="#"> <span class="icon-[tabler--folder] size-5"></span>Home</a>
            </li>
            <li class="breadcrumbs-separator rtl:rotate-180"><span class="icon-[tabler--chevron-right]"></span></li>
            <li>
                <a href="#" aria-label="More Pages"><span class="icon-[tabler--dots]"></span></a>
            </li>
            <li class="breadcrumbs-separator rtl:rotate-180"><span class="icon-[tabler--chevron-right]"></span></li>
            <li aria-current="page">
                <span class="icon-[tabler--file] me-1 size-5"></span>
                Produksi
            </li>
        </ol>
    </div>

    <div class="w-auto px-6 py-8 bg-white rounded-lg shadow-md mb-2 mt-2">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 align-middle">
            <div class="max-h-80">
                <img src="https://readymadeui.com/management-img.webp" alt="Image"
                    class="rounded-md object-cover w-full h-full" />
            </div>
            <div class="flex flex-col gap-4 md:gap-6 w-full md:11/12 lg:w-10/12">
                <h2 class="text-3xl font-extrabold text-purple-700 mb-4 font-space">
                    Managemen Produksi
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg gap-4">
                    <div
                        class="col-span-1 md:col-span-2 bg-orange-300 rounded-2xl p-5 shadow flex justify-start gap-8 align-middle items-center">
                        <div class="">
                            <div class="border-2 rounded-full bg-white p-4 border-red-500">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                                    class="size-10">
                                    <path fill-rule="evenodd"
                                        d="M7.502 6h7.128A3.375 3.375 0 0 1 18 9.375v9.375a3 3 0 0 0 3-3V6.108c0-1.505-1.125-2.811-2.664-2.94a48.972 48.972 0 0 0-.673-.05A3 3 0 0 0 15 1.5h-1.5a3 3 0 0 0-2.663 1.618c-.225.015-.45.032-.673.05C8.662 3.295 7.554 4.542 7.502 6ZM13.5 3A1.5 1.5 0 0 0 12 4.5h4.5A1.5 1.5 0 0 0 15 3h-1.5Z"
                                        clip-rule="evenodd" />
                                    <path fill-rule="evenodd"
                                        d="M3 9.375C3 8.339 3.84 7.5 4.875 7.5h9.75c1.036 0 1.875.84 1.875 1.875v11.25c0 1.035-.84 1.875-1.875 1.875h-9.75A1.875 1.875 0 0 1 3 20.625V9.375ZM6 12a.75.75 0 0 1 .75-.75h.008a.75.75 0 0 1 .75.75v.008a.75.75 0 0 1-.75.75H6.75a.75.75 0 0 1-.75-.75V12Zm2.25 0a.75.75 0 0 1 .75-.75h3.75a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75ZM6 15a.75.75 0 0 1 .75-.75h.008a.75.75 0 0 1 .75.75v.008a.75.75 0 0 1-.75.75H6.75a.75.75 0 0 1-.75-.75V15Zm2.25 0a.75.75 0 0 1 .75-.75h3.75a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75ZM6 18a.75.75 0 0 1 .75-.75h.008a.75.75 0 0 1 .75.75v.008a.75.75 0 0 1-.75.75H6.75a.75.75 0 0 1-.75-.75V18Zm2.25 0a.75.75 0 0 1 .75-.75h3.75a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75Z"
                                        clip-rule="evenodd" />
                                </svg>

                            </div>
                        </div>
                        <div class="flex flex-col px-2">
                            <span style="font-size: 32pt" class="font-semibold text-white">45</span>
                            <span class="text-gray-50 font-semibold">Total Produksi</span>
                        </div>
                    </div>
                    <div
                        class="bg-red-300  rounded-2xl p-5 shadow flex flex-wrap gap-8 align-middle items-center justify-start md:justify-between lg:justify-between"">
                        <div class="">
                            <div class="border-2 rounded-full bg-white p-4 border-yellow-500 text-yellow-500">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                                    class="size-10">
                                    <path fill-rule="evenodd"
                                        d="M4.755 10.059a7.5 7.5 0 0 1 12.548-3.364l1.903 1.903h-3.183a.75.75 0 1 0 0 1.5h4.992a.75.75 0 0 0 .75-.75V4.356a.75.75 0 0 0-1.5 0v3.18l-1.9-1.9A9 9 0 0 0 3.306 9.67a.75.75 0 1 0 1.45.388Zm15.408 3.352a.75.75 0 0 0-.919.53 7.5 7.5 0 0 1-12.548 3.364l-1.902-1.903h3.183a.75.75 0 0 0 0-1.5H2.984a.75.75 0 0 0-.75.75v4.992a.75.75 0 0 0 1.5 0v-3.18l1.9 1.9a9 9 0 0 0 15.059-4.035.75.75 0 0 0-.53-.918Z"
                                        clip-rule="evenodd" />
                                </svg>

                            </div>
                        </div>
                        <div class="flex flex-col">
                            <span style="font-size: 32pt" class="font-semibold">45</span>
                            <span class="text-gray-50 font-semibold">On Proccess</span>
                        </div>
                    </div>
                    <div
                        class="bg-green-300 rounded-2xl p-5 shadow flex flex-wrap gap-8 align-middle items-center justify-start md:justify-between lg:justify-between">
                        <div class="">
                            <div class="border-2 rounded-full bg-white p-4 border-yellow-500 text-yellow-500">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                                    class="size-10">
                                    <path fill-rule="evenodd"
                                        d="M7.502 6h7.128A3.375 3.375 0 0 1 18 9.375v9.375a3 3 0 0 0 3-3V6.108c0-1.505-1.125-2.811-2.664-2.94a48.972 48.972 0 0 0-.673-.05A3 3 0 0 0 15 1.5h-1.5a3 3 0 0 0-2.663 1.618c-.225.015-.45.032-.673.05C8.662 3.295 7.554 4.542 7.502 6ZM13.5 3A1.5 1.5 0 0 0 12 4.5h4.5A1.5 1.5 0 0 0 15 3h-1.5Z"
                                        clip-rule="evenodd" />
                                    <path fill-rule="evenodd"
                                        d="M3 9.375C3 8.339 3.84 7.5 4.875 7.5h9.75c1.036 0 1.875.84 1.875 1.875v11.25c0 1.035-.84 1.875-1.875 1.875h-9.75A1.875 1.875 0 0 1 3 20.625V9.375Zm9.586 4.594a.75.75 0 0 0-1.172-.938l-2.476 3.096-.908-.907a.75.75 0 0 0-1.06 1.06l1.5 1.5a.75.75 0 0 0 1.116-.062l3-3.75Z"
                                        clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                        <div class="flex flex-col">
                            <span style="font-size: 32pt" class="font-semibold">45</span>
                            <span class="text-gray-50 font-semibold">Complate</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-6 lg:grid-cols-10 py-3 gap-5" x-data="productionIndex">
        <div class="md:col-span-4 lg:col-span-7">
            {{-- <div class="card">
                <div class="card-body"> --}}
                    <div class="w-full overflow-x-auto bg-white border rounded-lg">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Kode</th>
                                    <th>Bucket</th>
                                    <th>Nilai BB</th>
                                    <th>Biaya Produksi</th>
                                    <th>Nilai Jual</th>
                                    <th>Tanggal</th>
                                    <th>Crafter</th>
                                    <th>Status</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="item in data">
                                    <tr class="item-start">
                                        <td>
                                            <span x-text="item.code_production" class="text-wrap">Bucket Production</span>
                                        </td>
                                        <td class="" style="width: 250pt">
                                            <span x-text="item.production_title"
                                                class="text-nowrap font-semibold w-52"></span>
                                        </td>
                                        <td>Rp. <span x-text="formatRupiah(item.cost_items)"></span></td>
                                        <td>Rp. <span x-text="formatRupiah(item.production_cost) ?? 00"></span></td>
                                        <td>Rp. <span x-text="formatRupiah(item.price_for_sale)"
                                                class="font-semibold"></span></td>
                                        <td class="text-nowrap" x-text="formatTanggalNoTime(item.created_at)"></td>
                                        <td>
                                            <span x-text="item.crafter.pegawai_name"></span>
                                        </td>
                                        <td>
                                            <div class="flex gap-2 flex-wrap">
                                                <span class="badge badge-soft badge-warning text-xs"
                                                    x-show="!item.production_status">PRODUCTION</span>
                                                <span class="badge badge-soft badge-success text-xs"
                                                    x-show="item.production_status">COMPLATE</span>
                                                <span class="badge badge-soft badge-primary text-xs"
                                                    x-show="item.preorder">PRE-ORDER</span>
                                            </div>
                                        </td>
                                        <td class="flex gap-1">
                                            <button title="mutasi to product" type="button"
                                                x-on:click="toDistribusi(item.id)"
                                                class="btn btn-circle btn-info btn-soft" aria-label="Action button"
                                                x-show="item.production_status">
                                                <span class="icon-[tabler--arrow-back-up-double] size-5"></span>
                                            </button>
                                            <button type="button" x-on:click="toComplate(item.id)"
                                                class="btn btn-circle btn-warning btn-soft" aria-label="Action button"
                                                x-show="!item.production_status" title="to complate">
                                                <span class="icon-[tabler--checks] size-5"></span>
                                            </button>

                                            <button class="btn btn-circle btn-soft btn-primary"
                                                title="lihat bahan baku" type="button" @click="detailFunc(item)">
                                                <span class="icon-[solar--eye-broken] size-5"></span>
                                            </button>

                                            <button @click="deleteProduct(item.id)"
                                                class="btn btn-circle btn-soft btn-error" title="Is deleted"
                                                type="button">
                                                <span class="icon-[lucide--trash-2] size-5"></span>
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>

                    <div class="py-4">
                        <nav class="flex justify-between gap-x-1">
                            <button type="button" class="btn btn-secondary btn-outline min-w-28" @click="prevPageFunc"
                                :disabled="!prevPage">
                                <span class="icon-[heroicons-outline--arrow-circle-left] size-5"></span>
                                Previous
                            </button>
                            <div class="flex items-center gap-x-1">

                                {{-- <button type="button"
                                    class="btn btn-outline btn-square aria-[current='page']:text-border-primary aria-[current='page']:bg-primary/10">1</button>
                                <button type="button"
                                    class="btn btn-outline btn-square aria-[current='page']:text-border-primary aria-[current='page']:bg-primary/10"
                                    aria-current="page">2</button>
                                <button type="button"
                                    class="btn btn-outline btn-square aria-[current='page']:text-border-primary aria-[current='page']:bg-primary/10">3</button> --}}

                            </div>
                            <button type="button" class="btn btn-secondary btn-outline min-w-28" :disabled="!nextPage"
                                @click="nextPageFunc">
                                Next
                                <span class="icon-[heroicons-outline--arrow-circle-right] size-5"></span>
                            </button>
                        </nav>
                    </div>

                {{-- </div> --}}

                {{-- modal detail --}}
                <button type="button" class="btn btn-primary hidden" aria-haspopup="dialog" id="open-modal-detail"
                    aria-expanded="false" aria-controls="large-modal" data-overlay="#large-modal">Large</button>

                <div id="large-modal" class="overlay modal overlay-open:opacity-100 hidden" role="dialog"
                    tabindex="-1">
                    <div class="modal-dialog overlay-open:opacity-100 modal-dialog-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3 class="modal-title">Detail Produksi</h3>
                                <button type="button" class="btn btn-text btn-circle btn-sm absolute end-3 top-3"
                                    aria-label="Close" data-overlay="#large-modal">
                                    <span class="icon-[tabler--x] size-4"></span>
                                </button>
                            </div>
                            <div class="modal-body">

                                <div class="border-base-content/25 w-full rounded-lg border">
                                    <div class="overflow-x-auto">
                                        <table class="table rounded">
                                            <thead>
                                                <tr>
                                                    <th>Name</th>
                                                    <th>Jumlah</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <template x-for="item in details">
                                                    <tr>
                                                        <td x-text="item.nama"></td>
                                                        <td x-text="item.jumlah"></td>
                                                        <td x-text="item.status ? 'Lainnya':'Bahan Baku'"></td>
                                                    </tr>
                                                </template>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-soft btn-secondary"
                                    data-overlay="#large-modal">Tutup</button>
                                {{-- <button type="button" class="btn btn-primary">Save changes</button> --}}
                            </div>
                        </div>
                    </div>
                </div>

            {{-- </div> --}}

        </div>
        <div class="md:col-span-2 lg:col-span-3 order-first md:order-last">
            <div class="card card-compact">
                <div class="card-header">
                    <h5 class="card-title px-4 font-muse">Barang Produksi</h5>
                </div>
                <hr>
                <div class="card-body">
                    <div class="p-4 pt-3 flex flex-col gap-5">
                        <div class="relative w-auto">
                            <input type="text" placeholder="" class="input input-floating peer" id=""
                                x-model="search.keyword" />

                            <label class="input-floating-label" for="">
                                Keywords
                            </label>
                        </div>
                        <div class="flex flex-col gap-2">
                            <input x-model="search.estimasi" type="text" class="input flatpickr-input"
                                placeholder="YYYY-MM-DD to YYYY-MM-DD" id="flatpickr-range" readonly="readonly">
                        </div>

                        <div class="relative w-auto">
                            <select x-model="search.status" class="select select-floating"
                                aria-label="Select floating label" id="selectFloating">
                                <option value="">Pilih...</option>
                                <option value="n">Produksi</option>
                                <option value="y">Selesai</option>
                            </select>
                            <label class="select-floating-label" for="selectFloating">
                                Crafter
                            </label>
                        </div>
                        <div class="relative w-auto">
                            <select x-model="search.crafter" class="select select-floating"
                                aria-label="Select floating label" id="selectFloating">
                                <option>Pilih...</option>
                            </select>
                            <label class="select-floating-label" for="selectFloating">
                                Crafter
                            </label>
                        </div>
                        <div class="relative w-auto">
                            <select x-model="search.range" class="select select-floating"
                                aria-label="Select floating label" id="selectFloating">
                                <option value="15">15</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                            <label class="select-floating-label" for="selectFloating">
                                Data Range
                            </label>
                        </div>
                    </div>
                </div>
                <div class="card-footer text-center">
                    <div class="grid grid-cols-1 gap-2 p-4">
                        <button class="btn btn-outline btn-primary w-auto" type="button"
                            @click="searchFunc">Filter</button>
                        <a href="{{ route('produksi.baru.index') }}" class="btn btn-outline btn-error w-auto">Produksi
                            Baru</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    @push('js')
        <script>
            window.addEventListener('load', function() {
                flatpickr('.jsPickr', {
                    allowInput: true,
                    monthSelectorType: 'static'
                })

                flatpickr('#flatpickr-range', {
                    mode: 'range'
                })
            })
        </script>
        <script>
            function productionIndex() {
                return {
                    data: [],
                    links: [],
                    nextPage: '',
                    prevPage: '',

                    search: {
                        keyword: '',
                        crafter: '',
                        status: "",
                        range: 5,
                        estimasi: ''
                    },
                    getData(url = "") {
                        if (!url) {
                            const params = new URLSearchParams({
                                keywords: this.search.keyword ?? "",
                                crafter: this.search.crafter ?? "",
                                status: this.search.status ?? "",
                                range: this.search.range ?? "",
                                estimasi:this.search.estimasi ?? ""
                            });
                            url = `/produksi/get-data-produksi?${params.toString()}`;
                        }

                        axios.get(url)
                            .then(res => {
                                // this.data = [];
                                const response = res.data.data;
                                this.data = response.data;
                                // Update link pagination dengan parameter pencarian terkini
                                this.links = this.processPaginationLinks(response.links);
                                this.nextPage = response.next_page_url ? this.addParamsToUrl(response.next_page_url) : null;
                                this.prevPage = response.prev_page_url ? this.addParamsToUrl(response.prev_page_url) : null;
                            })
                            .catch(erres => {
                                console.log(erres);
                            });
                    },
                    // Fungsi untuk menambahkan parameter pencarian ke semua link pagination
                    processPaginationLinks(links) {
                        return links.map(link => {
                            if (link.url) {
                                return {
                                    ...link,
                                    url: this.addParamsToUrl(link.url)
                                };
                            }
                            return link;
                        });
                    },
                    // Fungsi untuk menambahkan parameter pencarian ke URL
                    addParamsToUrl(url) {
                        if (!url) return null;
                        const newUrl = new URL(url);
                        const searchParams = new URLSearchParams(newUrl.search);
                        // Tambahkan parameter pencarian terkini
                        searchParams.set('keywords', this.search.keyword);
                        searchParams.set('crafter', this.search.crafter);
                        searchParams.set('status', this.search.status);
                        searchParams.set('range', this.search.range);
                        searchParams.set('estimasi', this.search.estimasi);

                        newUrl.search = searchParams.toString();
                        return newUrl.toString();
                    },

                    nextPageFunc() {
                        if (this.nextPage) {
                            this.getData(this.nextPage);
                        }
                    },

                    prevPageFunc() {
                        if (this.prevPage) {
                            this.getData(this.prevPage);
                        }
                    },

                    searchFunc() {

                        console.log('Search params before send:', this.search);
                        const params = new URLSearchParams({
                            keywords: this.search.keyword,
                            crafter: this.search.crafter,
                            status: this.search.status,
                            range: this.search.range,
                            estimasi: this.search.estimasi
                        });
                        url = `/produksi/get-data-produksi?${params.toString()}`;
                        console.log('Final URL:', url);
                        this.getData(url);
                    },

                    toComplate(index) {
                        Swal.fire({
                            title: "Konfirmasi",
                            text: "Apakah bucket selesai produksi ?",
                            icon: "question",
                            showCancelButton: true,
                            confirmButtonColor: "#3085d6",
                            cancelButtonColor: "#d33",
                            confirmButtonText: "Ya, Selesai",
                            cancelButtonText: "Batal"
                        }).then((result) => {
                            if (result.isConfirmed) {
                                Swal.fire({
                                    icon: 'info',
                                    title: 'Processing...',
                                    html: 'Mohon tunggu sebentar',
                                    allowOutsideClick: false,
                                    didOpen: () => {
                                        Swal.showLoading()
                                    }
                                });

                                axios.get(`/produksi/to-complate/${index}`)
                                    .then(response => {
                                        Swal.fire({
                                            title: "Berhasil!",
                                            text: "Data produksi berhasil diupdated.",
                                            icon: "success"
                                        });
                                    })
                                    .catch(error => {
                                        Swal.fire({
                                            title: "Error!",
                                            text: "Terjadi kesalahan saat update data.",
                                            icon: "error"
                                        });
                                    }).finally(() => {
                                        this.getData()
                                    });
                            }
                        });
                    },
                    toDistribusi(index) {
                        Swal.fire({
                            title: "Konfirmasi",
                            text: "Yakin ingin distribusi produk kedaftar penjualan ?",
                            icon: "info",
                            showCancelButton: true,
                            confirmButtonColor: "#3085d6",
                            cancelButtonColor: "#d33",
                            confirmButtonText: "Ya, Proses",
                            cancelButtonText: "Batal"
                        }).then((result) => {
                            if (result.isConfirmed) {
                                Swal.fire({
                                    icon: 'info',
                                    title: 'Processing...',
                                    html: 'Mohon tunggu sebentar',
                                    allowOutsideClick: false,
                                    didOpen: () => {
                                        Swal.showLoading()
                                    }
                                });

                                axios.get(`/produksi/distribution-to-product/${index}`)
                                    .then(response => {
                                        Swal.fire({
                                            title: "Berhasil!",
                                            text: "Distrubiton product successfully..",
                                            icon: "success"
                                        });
                                    })
                                    .catch(error => {
                                        const res = error.response.data
                                        console.log(res);
                                        if (error.status === 405) {
                                            Swal.fire({
                                                title: res.status,
                                                text: res.message,
                                                icon: "info"
                                            });
                                            return;
                                        }

                                        Swal.fire({
                                            title: "Error!",
                                            text: "Distribusi gagal diproses.",
                                            icon: "error"
                                        });
                                    });
                            }
                        });
                    },
                    details: [],
                    detailFunc(item) {
                        const openModal = document.getElementById("open-modal-detail");
                        axios.get(`/produksi/get-production-detail/${item.id}`)
                            .then((res) => {
                                const data = res.data.data;
                                console.log(data);

                                this.details = data;
                                openModal.click();
                            }).catch((err) => {
                                console.log(err)
                            })
                    },
                    deleteProduct(key) {
                        Swal.fire({
                            title: "Konfirmasi",
                            text: "Apakah anda yakin ingin menghapus produk ini?",
                            icon: "warning",
                            showCancelButton: true,
                            confirmButtonColor: "#3085d6",
                            cancelButtonColor: "#d33",
                            confirmButtonText: "Hapus",
                            cancelButtonText: "Batal"
                        }).then((result) => {
                            if (result.isConfirmed) {
                                Swal.fire({
                                    icon: 'info',
                                    title: 'Processing...',
                                    html: 'Mohon tunggu sebentar',
                                    allowOutsideClick: false,
                                    didOpen: () => {
                                        Swal.showLoading()
                                    }
                                });
                                axios.post(`/produksi/delete/${key}`, {
                                        id: key
                                    })
                                    .then(response => {
                                        Swal.fire({
                                            title: "Berhasil!",
                                            text: "Data produk berhasil dihapus.",
                                            icon: "success"
                                        });
                                        this.getData()
                                    })
                                    .catch(error => {
                                        const message = error.response.data.message;
                                        if (error.status === 400) {
                                            Swal.fire({
                                                title: "Invalid",
                                                text: message,
                                                icon: "warning"
                                            });
                                            return;
                                        }

                                        Swal.fire({
                                            title: "Error!",
                                            text: "Terjadi kesalahan saat menghapus data.",
                                            icon: "error"
                                        });
                                    });
                            }
                        });
                    },
                    init() {
                        this.getData()
                    }
                }
            }
        </script>
    @endpush
</x-base-layout>
